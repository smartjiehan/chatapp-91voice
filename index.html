<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC聊天室 - 局域网与互联网</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5865f2;
            --primary-hover: #4752c4;
            --background-primary: #36393f;
            --background-secondary: #2f3136;
            --background-tertiary: #202225;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --text-bright: #ffffff;
            --success-color: #3ba55d;
            --error-color: #ed4245;
            --warning-color: #faa81a;
            --local-network: #43b581;
            --internet: #eb459e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--background-primary);
            color: var(--text-normal);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: var(--background-secondary);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar {
            width: 300px;
            background: var(--background-tertiary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.06);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            background: var(--background-tertiary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--background-primary);
        }

        .chat-input {
            padding: 20px;
            background: var(--background-tertiary);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            font-size: 16px;
        }

        .send-button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-button:hover {
            background: var(--primary-hover);
        }

        .message {
            display: flex;
            margin-bottom: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 5px;
            gap: 10px;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-bright);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .message-text {
            font-size: 16px;
            line-height: 1.4;
            color: var(--text-normal);
        }

        .system-message {
            background: rgba(79, 84, 92, 0.3);
            color: var(--text-muted);
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .user-list {
            margin-top: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
            background: var(--background-primary);
            margin-top: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: var(--success-color);
        }

        .status-connecting {
            background: var(--warning-color);
        }

        .status-disconnected {
            background: var(--error-color);
        }

        .connect-section {
            margin-top: 20px;
        }

        .connect-input {
            width: 100%;
            padding: 10px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            margin-bottom: 10px;
        }

        .connect-button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .my-id {
            background: var(--background-primary);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
            word-break: break-all;
        }

        .id-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            background: var(--background-tertiary);
            color: var(--text-bright);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        .debug-panel {
            background: var(--background-tertiary);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .debug-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .debug-content {
            font-family: monospace;
            white-space: pre-wrap;
        }

        .toggle-debug {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            margin-top: 5px;
        }

        .server-config {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .server-select {
            width: 100%;
            padding: 8px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            margin-bottom: 10px;
        }

        .action-button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .action-button.secondary {
            background: var(--background-primary);
        }
        
        .network-type {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
            background: var(--background-primary);
            margin-top: 10px;
        }
        
        .network-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .network-local {
            background: var(--local-network);
        }
        
        .network-internet {
            background: var(--internet);
        }
        
        .info-section {
            background: rgba(79, 84, 92, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .info-section h4 {
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        
        .info-section ul {
            padding-left: 20px;
            margin-bottom: 8px;
        }
        
        .info-section li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>聊天室成员</h3>
            <div class="user-list" id="userList">
                <div class="user-item">
                    <div class="user-avatar" id="myAvatar">ME</div>
                    <div id="myUsername">我</div>
                </div>
            </div>
            
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">正在连接...</span>
            </div>
            
            <div class="network-type">
                <i class="fas fa-network-wired"></i>
                <span>连接类型:</span>
                <span class="network-badge network-local" id="networkType">未知</span>
            </div>
            
            <div class="connect-section">
                <div class="id-label">我的ID:</div>
                <div class="my-id" id="myId">生成中...</div>
                
                <div class="id-label">连接其他用户:</div>
                <input type="text" class="connect-input" id="connectInput" placeholder="输入对方ID">
                <button class="connect-button" id="connectButton">连接</button>
            </div>
            
            <div class="server-config">
                <div class="id-label">信令服务器:</div>
                <select class="server-select" id="serverSelect">
                    <option value="default">默认服务器 (0.peerjs.com)</option>
                    <option value="heroku">Heroku服务器 (peerjs-server.herokuapp.com)</option>
                    <option value="custom">自定义服务器...</option>
                </select>
                <div id="customServerConfig" style="display: none;">
                    <input type="text" class="connect-input" id="customHost" placeholder="主机地址">
                    <input type="number" class="connect-input" id="customPort" placeholder="端口" value="443">
                    <input type="text" class="connect-input" id="customPath" placeholder="路径" value="/">
                </div>
                <button class="action-button secondary" id="reconnectButton">重新连接</button>
            </div>
            
            <div class="info-section">
                <h4>连接信息</h4>
                <p>此聊天室支持:</p>
                <ul>
                    <li>局域网内直接通信</li>
                    <li>互联网上的P2P通信</li>
                    <li>最多可连接20+用户</li>
                </ul>
                <p>连接类型将根据网络环境自动检测。</p>
            </div>
            
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div class="debug-title">调试信息:</div>
                <div class="debug-content" id="debugContent"></div>
            </div>
            <button class="toggle-debug" id="toggleDebug">显示调试信息</button>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h2>WebRTC聊天室</h2>
                <div id="peerCount">连接数: 0</div>
            </div>
            
            <div class="chat-messages" id="messagesContainer">
                <div class="system-message">
                    欢迎使用WebRTC聊天室！支持局域网和互联网通信。
                </div>
                <div class="system-message">
                    提示：要连接互联网用户，需要双方使用相同的信令服务器。
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" class="message-input" id="messageInput" placeholder="输入消息..." disabled>
                    <button class="send-button" id="sendButton" disabled>发送</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // 生成用户标识
        function generateUserIdentifier() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // 用户管理
        class UserManager {
            constructor() {
                this.currentUser = null;
                this.userIdentifier = this.loadUserIdentifier();
                this.connectedPeers = new Map();
                this.users = new Map();
                this.connectionTypes = new Map(); // 存储连接类型
            }

            loadUserIdentifier() {
                let identifier = localStorage.getItem('userIdentifier');
                if (!identifier) {
                    identifier = generateUserIdentifier();
                    localStorage.setItem('userIdentifier', identifier);
                }
                return identifier;
            }

            setUsername(username) {
                if (!username || username.trim() === '') {
                    username = '匿名用户';
                }
                
                this.currentUser = {
                    username: username.trim(),
                    identifier: this.userIdentifier,
                    peerId: null
                };
                
                localStorage.setItem('username', username);
                return this.currentUser;
            }

            loadUsername() {
                return localStorage.getItem('username') || '';
            }

            getCurrentUser() {
                return this.currentUser;
            }

            addPeer(peerId, connection, userInfo = null, connectionType = 'unknown') {
                this.connectedPeers.set(peerId, connection);
                this.connectionTypes.set(peerId, connectionType);
                
                if (userInfo) {
                    this.users.set(peerId, userInfo);
                }
                
                this.updatePeerCount();
                return this.connectedPeers.size;
            }

            removePeer(peerId) {
                this.connectedPeers.delete(peerId);
                this.users.delete(peerId);
                this.connectionTypes.delete(peerId);
                this.updatePeerCount();
                return this.connectedPeers.size;
            }

            updatePeerCount() {
                document.getElementById('peerCount').textContent = 
                    `连接数: ${this.connectedPeers.size}`;
                
                document.getElementById('statusText').textContent = 
                    `已连接 ${this.connectedPeers.size} 人`;
            }

            broadcast(message) {
                this.connectedPeers.forEach((conn, peerId) => {
                    try {
                        conn.send(message);
                    } catch (error) {
                        console.error('发送消息失败:', error);
                        addDebugLog('发送消息失败: ' + error.message);
                    }
                });
            }

            getUserInfo(peerId) {
                return this.users.get(peerId);
            }

            setUserInfo(peerId, userInfo) {
                this.users.set(peerId, userInfo);
            }
            
            setConnectionType(peerId, type) {
                this.connectionTypes.set(peerId, type);
                this.updateUserList();
            }
            
            updateUserList() {
                // 清除现有用户列表（除了自己）
                const userList = document.getElementById('userList');
                const myUserItem = document.getElementById('user-item-me');
                userList.innerHTML = '';
                if (myUserItem) {
                    userList.appendChild(myUserItem);
                }
                
                // 添加所有连接的用户
                this.users.forEach((userInfo, peerId) => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.id = `user-${peerId}`;
                    
                    const connectionType = this.connectionTypes.get(peerId) || 'unknown';
                    const typeBadge = connectionType === 'local' ? 
                        '<span class="network-badge network-local">局域网</span>' : 
                        '<span class="network-badge network-internet">互联网</span>';
                    
                    userItem.innerHTML = `
                        <div class="user-avatar">${userInfo.user[0]?.toUpperCase() || '?'}</div>
                        <div>${userInfo.user}</div>
                        <div style="margin-left: auto;">${typeBadge}</div>
                    `;
                    
                    userList.appendChild(userItem);
                });
            }
        }

        // 初始化用户管理器
        const userManager = new UserManager();

        // DOM 元素
        const elements = {
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            userList: document.getElementById('userList'),
            myId: document.getElementById('myId'),
            myAvatar: document.getElementById('myAvatar'),
            myUsername: document.getElementById('myUsername'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            connectInput: document.getElementById('connectInput'),
            connectButton: document.getElementById('connectButton'),
            peerCount: document.getElementById('peerCount'),
            notification: document.getElementById('notification'),
            debugPanel: document.getElementById('debugPanel'),
            debugContent: document.getElementById('debugContent'),
            toggleDebug: document.getElementById('toggleDebug'),
            serverSelect: document.getElementById('serverSelect'),
            customServerConfig: document.getElementById('customServerConfig'),
            customHost: document.getElementById('customHost'),
            customPort: document.getElementById('customPort'),
            customPath: document.getElementById('customPath'),
            reconnectButton: document.getElementById('reconnectButton'),
            networkType: document.getElementById('networkType')
        };

        // PeerJS 实例
        let peer;
        let myPeerId;
        let debugLogs = [];
        let currentServerConfig = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // 服务器配置
        const SERVER_CONFIGS = {
            default: {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                label: '默认服务器'
            },
            heroku: {
                host: 'peerjs-server.herokuapp.com',
                port: 443,
                path: '/',
                label: 'Heroku服务器'
            },
            custom: {
                host: '',
                port: 443,
                path: '/',
                label: '自定义服务器'
            }
        };

        // 添加调试日志
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push(`[${timestamp}] ${message}`);
            
            // 限制日志数量
            if (debugLogs.length > 50) {
                debugLogs = debugLogs.slice(-50);
            }
            
            // 更新调试面板内容
            if (elements.debugPanel.style.display === 'block') {
                elements.debugContent.textContent = debugLogs.join('\n');
            }
        }

        // 初始化事件监听
        function initEvents() {
            // 发送消息按钮
            elements.sendButton.addEventListener('click', sendMessage);
            
            // 回车键发送消息
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 连接按钮
            elements.connectButton.addEventListener('click', connectToPeerInput);
            
            // 调试面板切换
            elements.toggleDebug.addEventListener('click', toggleDebugPanel);
            
            // 服务器选择
            elements.serverSelect.addEventListener('change', handleServerChange);
            
            // 重新连接按钮
            elements.reconnectButton.addEventListener('click', reconnectToServer);
            
            // 加载保存的用户名
            const savedUsername = userManager.loadUsername();
            if (savedUsername) {
                userManager.setUsername(savedUsername);
                elements.myUsername.textContent = savedUsername;
                elements.myAvatar.textContent = savedUsername[0].toUpperCase();
                
                // 添加自己到用户列表
                const myUserItem = document.createElement('div');
                myUserItem.className = 'user-item';
                myUserItem.id = 'user-item-me';
                myUserItem.innerHTML = `
                    <div class="user-avatar">${savedUsername[0]?.toUpperCase() || '?'}</div>
                    <div>${savedUsername} (我)</div>
                    <div style="margin-left: auto;"><span class="network-badge network-local">本机</span></div>
                `;
                elements.userList.appendChild(myUserItem);
            } else {
                // 提示用户输入用户名
                setTimeout(() => {
                    const username = prompt('请输入您的昵称:', '匿名用户');
                    if (username) {
                        userManager.setUsername(username);
                        elements.myUsername.textContent = username;
                        elements.myAvatar.textContent = username[0].toUpperCase();
                        
                        // 添加自己到用户列表
                        const myUserItem = document.createElement('div');
                        myUserItem.className = 'user-item';
                        myUserItem.id = 'user-item-me';
                        myUserItem.innerHTML = `
                            <div class="user-avatar">${username[0]?.toUpperCase() || '?'}</div>
                            <div>${username} (我)</div>
                            <div style="margin-left: auto;"><span class="network-badge network-local">本机</span></div>
                        `;
                        elements.userList.appendChild(myUserItem);
                    }
                }, 500);
            }
            
            // 加载服务器配置
            loadServerConfig();
        }

        // 处理服务器选择变化
        function handleServerChange() {
            const selectedServer = elements.serverSelect.value;
            
            if (selectedServer === 'custom') {
                elements.customServerConfig.style.display = 'block';
                
                // 加载自定义服务器配置
                const customConfig = JSON.parse(localStorage.getItem('customServerConfig') || '{}');
                elements.customHost.value = customConfig.host || '';
                elements.customPort.value = customConfig.port || '443';
                elements.customPath.value = customConfig.path || '/';
            } else {
                elements.customServerConfig.style.display = 'none';
                currentServerConfig = {...SERVER_CONFIGS[selectedServer]};
                localStorage.setItem('selectedServer', selectedServer);
                
                // 重新连接
                reconnectToServer();
            }
        }

        // 保存自定义服务器配置
        function saveCustomServerConfig() {
            const customConfig = {
                host: elements.customHost.value,
                port: parseInt(elements.customPort.value) || 443,
                path: elements.customPath.value || '/'
            };
            
            localStorage.setItem('customServerConfig', JSON.stringify(customConfig));
            currentServerConfig = {...customConfig, label: '自定义服务器'};
            
            return customConfig;
        }

        // 加载服务器配置
        function loadServerConfig() {
            const selectedServer = localStorage.getItem('selectedServer') || 'default';
            elements.serverSelect.value = selectedServer;
            
            if (selectedServer === 'custom') {
                const customConfig = JSON.parse(localStorage.getItem('customServerConfig') || '{}');
                SERVER_CONFIGS.custom = {
                    ...SERVER_CONFIGS.custom,
                    ...customConfig
                };
                elements.customServerConfig.style.display = 'block';
                elements.customHost.value = customConfig.host || '';
                elements.customPort.value = customConfig.port || '443';
                elements.customPath.value = customConfig.path || '/';
            }
            
            currentServerConfig = {...SERVER_CONFIGS[selectedServer]};
        }

        // 重新连接到服务器
        function reconnectToServer() {
            if (elements.serverSelect.value === 'custom') {
                saveCustomServerConfig();
            }
            
            addDebugLog(`正在重新连接到服务器: ${currentServerConfig.label}`);
            updateConnectionStatus('connecting', '正在重新连接...');
            
            // 销毁现有Peer实例
            if (peer) {
                try {
                    peer.destroy();
                } catch (e) {
                    console.error('销毁Peer实例时出错:', e);
                }
            }
            
            // 重置重连尝试计数
            reconnectAttempts = 0;
            
            // 重新初始化
            setTimeout(initPeerJS, 1000);
        }

        // 显示通知
        function showNotification(message, isError = false) {
            const notification = elements.notification;
            notification.textContent = message;
            notification.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--background-tertiary)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 切换调试面板
        function toggleDebugPanel() {
            const isVisible = elements.debugPanel.style.display === 'block';
            elements.debugPanel.style.display = isVisible ? 'none' : 'block';
            elements.toggleDebug.textContent = isVisible ? '显示调试信息' : '隐藏调试信息';
            
            if (!isVisible) {
                elements.debugContent.textContent = debugLogs.join('\n');
            }
        }

        // 初始化PeerJS - 使用可配置服务器
        function initPeerJS() {
            // 生成随机ID
            myPeerId = Math.random().toString(36).substr(2, 9);
            
            addDebugLog(`正在初始化PeerJS连接至: ${currentServerConfig.host}`);
            updateConnectionStatus('connecting', `正在连接至 ${currentServerConfig.label}...`);
            
            // 使用配置的服务器
            peer = new Peer(myPeerId, {
                host: currentServerConfig.host,
                port: currentServerConfig.port,
                path: currentServerConfig.path,
                debug: 3,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                addDebugLog(`PeerJS连接已建立，ID: ${id} (服务器: ${currentServerConfig.label})`);
                elements.myId.textContent = id;
                userManager.getCurrentUser().peerId = id;
                updateConnectionStatus('connected', `已连接到 ${currentServerConfig.label}`);
                
                // 启用聊天功能
                elements.messageInput.disabled = false;
                elements.sendButton.disabled = false;
                
                // 重置重连尝试计数
                reconnectAttempts = 0;
                
                // 广播用户加入消息
                broadcastUserJoin();
            });
            
            peer.on('connection', (conn) => {
                addDebugLog('收到连接请求: ' + conn.peer);
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                addDebugLog(`PeerJS错误 (${currentServerConfig.label}): ${err}`);
                
                if (err.toString().includes('Could not connect to peer server')) {
                    updateConnectionStatus('error', `无法连接到 ${currentServerConfig.label}`);
                    
                    // 尝试使用备选方案
                    reconnectAttempts++;
                    
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        addDebugLog(`尝试 ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}: 正在尝试其他服务器...`);
                        
                        // 切换到下一个服务器
                        switchToNextServer();
                        
                        // 延迟后重试
                        setTimeout(() => {
                            reconnectToServer();
                        }, 2000);
                    } else {
                        // 所有服务器尝试失败
                        updateConnectionStatus('error', '所有服务器连接失败');
                        showNotification('无法连接到任何信令服务器', true);
                    }
                } else {
                    updateConnectionStatus('error', '连接错误: ' + err);
                    showNotification('连接错误: ' + err, true);
                }
            });
            
            peer.on('disconnected', () => {
                addDebugLog('与信令服务器的连接已断开');
                updateConnectionStatus('disconnected', '连接断开');
                
                // 尝试重新连接
                setTimeout(() => {
                    addDebugLog('尝试重新连接到信令服务器...');
                    peer.reconnect();
                }, 2000);
            });
        }

        // 广播用户加入消息
        function broadcastUserJoin() {
            const user = userManager.getCurrentUser();
            userManager.broadcast({
                type: 'user_join',
                user: user.username,
                identifier: user.identifier,
                peerId: user.peerId
            });
        }

        // 切换到下一个可用服务器
        function switchToNextServer() {
            const servers = ['default', 'heroku', 'custom'];
            const currentServer = elements.serverSelect.value;
            let currentIndex = servers.indexOf(currentServer);
            
            // 切换到下一个服务器
            currentIndex = (currentIndex + 1) % servers.length;
            const nextServer = servers[currentIndex];
            
            elements.serverSelect.value = nextServer;
            currentServerConfig = {...SERVER_CONFIGS[nextServer]};
            
            addDebugLog(`切换到服务器: ${currentServerConfig.label}`);
        }

        // 处理手动连接输入
        function connectToPeerInput() {
            const peerId = elements.connectInput.value.trim();
            if (!peerId) return;
            
            connectToPeer(peerId);
            elements.connectInput.value = '';
        }

        // 连接到其他用户
        function connectToPeer(peerId) {
            if (peerId === myPeerId) {
                addDebugLog('不能连接到自己');
                showNotification('不能连接到自己', true);
                return;
            }
            
            // 检查是否已经连接
            if (userManager.connectedPeers.has(peerId)) {
                addDebugLog('已经连接到该用户: ' + peerId);
                showNotification('已经连接到该用户', true);
                return;
            }
            
            addDebugLog('正在连接到: ' + peerId);
            
            // 建立连接
            const conn = peer.connect(peerId, {
                reliable: true
            });
            
            if (!conn) {
                addDebugLog('创建连接对象失败');
                showNotification('创建连接失败', true);
                return;
            }
            
            conn.on('open', () => {
                addDebugLog('连接成功: ' + peerId);
                setupConnection(conn);
                
                // 发送用户信息
                const user = userManager.getCurrentUser();
                conn.send({
                    type: 'user_join',
                    user: user.username,
                    identifier: user.identifier,
                    peerId: user.peerId
                });
                
                showNotification(`已连接到用户: ${peerId}`);
                
                // 检测连接类型
                detectConnectionType(conn);
            });
            
            conn.on('error', (err) => {
                addDebugLog('连接错误: ' + err);
                showNotification('连接失败: ' + err, true);
            });
        }

        // 检测连接类型（局域网或互联网）
        function detectConnectionType(conn) {
            // 简单检测方法：检查对等ID是否与本地IP相关
            // 实际应用中可以使用更复杂的检测方法
            const localIPs = ['192.168.', '10.', '172.16.', '172.17.', '172.18.', '172.19.', '172.20.', '172.21.', '172.22.', '172.23.', '172.24.', '172.25.', '172.26.', '172.27.', '172.28.', '172.29.', '172.30.', '172.31.', '169.254.'];
            
            let isLocal = false;
            for (const ipPrefix of localIPs) {
                if (conn.peer.includes(ipPrefix)) {
                    isLocal = true;
                    break;
                }
            }
            
            const connectionType = isLocal ? 'local' : 'internet';
            userManager.setConnectionType(conn.peer, connectionType);
            
            // 更新网络类型显示
            updateNetworkTypeDisplay();
            
            addDebugLog(`检测到连接类型: ${connectionType} (${conn.peer})`);
        }

        // 更新网络类型显示
        function updateNetworkTypeDisplay() {
            let hasLocal = false;
            let hasInternet = false;
            
            userManager.connectionTypes.forEach(type => {
                if (type === 'local') hasLocal = true;
                if (type === 'internet') hasInternet = true;
            });
            
            if (hasInternet) {
                elements.networkType.textContent = '互联网';
                elements.networkType.className = 'network-badge network-internet';
            } else if (hasLocal) {
                elements.networkType.textContent = '局域网';
                elements.networkType.className = 'network-badge network-local';
            } else {
                elements.networkType.textContent = '未知';
                elements.networkType.className = 'network-badge';
            }
        }

        // 设置连接
        function setupConnection(conn) {
            // 存储连接
            userManager.addPeer(conn.peer, conn);
            
            // 监听数据
            conn.on('data', (data) => {
                addDebugLog('收到数据: ' + JSON.stringify(data).substring(0, 100));
                handleIncomingData(data, conn.peer);
            });
            
            conn.on('close', () => {
                addDebugLog('连接关闭: ' + conn.peer);
                const userInfo = userManager.getUserInfo(conn.peer);
                if (userInfo) {
                    addSystemMessage(`用户 ${userInfo.username} 已断开连接`);
                }
                userManager.removePeer(conn.peer);
                removeUserFromList(conn.peer);
                updateNetworkTypeDisplay();
            });
            
            conn.on('error', (err) => {
                addDebugLog('连接错误: ' + err);
                userManager.removePeer(conn.peer);
                removeUserFromList(conn.peer);
                updateNetworkTypeDisplay();
            });
        }

        // 处理传入数据
        function handleIncomingData(data, peerId) {
            if (data.type === 'message') {
                // 渲染消息
                renderMessage(data);
            } else if (data.type === 'user_join') {
                userManager.setUserInfo(peerId, data);
                addUserToList(peerId, data.user);
                addSystemMessage(`用户 ${data.user} 已加入聊天`);
                
                // 检测连接类型
                if (userManager.connectedPeers.has(peerId)) {
                    detectConnectionType(userManager.connectedPeers.get(peerId));
                }
            }
        }

        // 发送消息
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) return;
            
            const user = userManager.getCurrentUser();
            if (!user) return;
            
            const message = {
                type: 'message',
                user: user.username,
                identifier: user.identifier,
                text: text,
                timestamp: Date.now()
            };
            
            // 广播消息
            userManager.broadcast(message);
            
            // 清空输入框
            elements.messageInput.value = '';
            
            // 本地渲染消息
            renderMessage(message);
        }

        // 渲染消息
        function renderMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${message.user[0]?.toUpperCase() || '?'}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.user}</span>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // 格式化时间
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 添加系统消息
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // 添加用户到列表
        function addUserToList(peerId, username) {
            // 检查是否已存在
            if (document.getElementById(`user-${peerId}`)) return;
            
            userManager.updateUserList();
        }

        // 从列表中移除用户
        function removeUserFromList(peerId) {
            const userElement = document.getElementById(`user-${peerId}`);
            if (userElement) {
                userElement.remove();
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, text) {
            if (elements.statusDot && elements.statusText) {
                // 清除所有状态类
                elements.statusDot.className = 'status-dot';
                
                if (status === 'connected') {
                    elements.statusDot.classList.add('status-connected');
                } else if (status === 'connecting') {
                    elements.statusDot.classList.add('status-connecting');
                } else {
                    elements.statusDot.classList.add('status-disconnected');
                }
                
                elements.statusText.textContent = text;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initEvents();
            initPeerJS();
        });
    </script>
</body>
</html>
