<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>91Voice - WebRTC聊天室</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5865f2;
            --primary-hover: #4752c4;
            --background-primary: #36393f;
            --background-secondary: #2f3136;
            --background-tertiary: #202225;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --text-bright: #ffffff;
            --success-color: #3ba55d;
            --error-color: #ed4245;
            --warning-color: #faa81a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--background-primary);
            color: var(--text-normal);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            height: 90vh;
            background: var(--background-secondary);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar {
            width: 280px;
            background: var(--background-tertiary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.06);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            background: var(--background-tertiary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--background-primary);
        }

        .chat-input {
            padding: 20px;
            background: var(--background-tertiary);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            font-size: 16px;
        }

        .send-button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-button:hover {
            background: var(--primary-hover);
        }

        .message {
            display: flex;
            margin-bottom: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 5px;
            gap: 10px;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-bright);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .message-text {
            font-size: 16px;
            line-height: 1.4;
            color: var(--text-normal);
        }

        .system-message {
            background: rgba(79, 84, 92, 0.3);
            color: var(--text-muted);
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .user-list {
            margin-top: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
            background: var(--background-primary);
            margin-top: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: var(--success-color);
        }

        .status-connecting {
            background: var(--warning-color);
        }

        .status-disconnected {
            background: var(--error-color);
        }

        .connect-section {
            margin-top: 20px;
        }

        .connect-input {
            width: 100%;
            padding: 10px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            margin-bottom: 10px;
        }

        .connect-button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .my-id {
            background: var(--background-primary);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
            word-break: break-all;
        }

        .id-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .room-section {
            margin-top: 20px;
        }

        .room-code {
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            margin: 10px 0;
            color: var(--primary-color);
            background: rgba(88, 101, 242, 0.1);
            padding: 8px;
            border-radius: 5px;
        }

        .action-button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .action-button.secondary {
            background: var(--background-primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            background: var(--background-tertiary);
            color: var(--text-bright);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>聊天室成员</h3>
            <div class="user-list" id="userList">
                <div class="user-item">
                    <div class="user-avatar" id="myAvatar">ME</div>
                    <div id="myUsername">我</div>
                </div>
            </div>
            
            <div class="connection-status">
                <div class="status-dot status-connected" id="statusDot"></div>
                <span id="statusText">已连接 1 人</span>
            </div>
            
            <div class="connect-section">
                <div class="id-label">我的ID:</div>
                <div class="my-id" id="myId">生成中...</div>
            </div>
            
            <div class="room-section">
                <div class="id-label">房间代码:</div>
                <div class="room-code" id="roomCode">未设置</div>
                <button class="action-button" id="createRoomBtn">创建新房间</button>
                <button class="action-button secondary" id="joinRoomBtn">加入房间</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h2>WebRTC多人聊天室</h2>
                <div id="peerCount">连接数: 0</div>
            </div>
            
            <div class="chat-messages" id="messagesContainer">
                <div class="system-message">
                    欢迎使用WebRTC多人聊天室！请创建或加入一个房间开始聊天。
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" class="message-input" id="messageInput" placeholder="输入消息..." disabled>
                    <button class="send-button" id="sendButton" disabled>发送</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // 生成用户标识
        function generateUserIdentifier() {
            const macPart = Array.from({length: 6}, () => 
                Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
            ).join(':');
            
            const ipPart = Array.from({length: 4}, () => 
                Math.floor(Math.random() * 256)
            ).join('.');
            
            return { mac: macPart, ip: ipPart };
        }

        // 用户管理
        class UserManager {
            constructor() {
                this.currentUser = null;
                this.userIdentifier = this.loadUserIdentifier();
                this.connectedPeers = new Map();
                this.users = new Map();
            }

            loadUserIdentifier() {
                let identifier = localStorage.getItem('userIdentifier');
                if (!identifier) {
                    identifier = JSON.stringify(generateUserIdentifier());
                    localStorage.setItem('userIdentifier', identifier);
                }
                return JSON.parse(identifier);
            }

            setUsername(username) {
                if (!username || username.trim() === '') {
                    username = '匿名用户';
                }
                
                this.currentUser = {
                    username: username.trim(),
                    identifier: this.userIdentifier,
                    peerId: null
                };
                
                localStorage.setItem('username', username);
                return this.currentUser;
            }

            loadUsername() {
                return localStorage.getItem('username') || '';
            }

            getCurrentUser() {
                return this.currentUser;
            }

            addPeer(peerId, connection, userInfo = null) {
                this.connectedPeers.set(peerId, connection);
                
                if (userInfo) {
                    this.users.set(peerId, userInfo);
                }
                
                this.updatePeerCount();
                return this.connectedPeers.size;
            }

            removePeer(peerId) {
                this.connectedPeers.delete(peerId);
                this.users.delete(peerId);
                this.updatePeerCount();
                return this.connectedPeers.size;
            }

            updatePeerCount() {
                document.getElementById('peerCount').textContent = 
                    `连接数: ${this.connectedPeers.size}`;
                
                document.getElementById('statusText').textContent = 
                    `已连接 ${this.connectedPeers.size + 1} 人`;
            }

            broadcast(message) {
                this.connectedPeers.forEach(conn => {
                    try {
                        conn.send(message);
                    } catch (error) {
                        console.error('发送消息失败:', error);
                    }
                });
            }

            getUserInfo(peerId) {
                return this.users.get(peerId);
            }

            setUserInfo(peerId, userInfo) {
                this.users.set(peerId, userInfo);
            }
        }

        // 房间管理
        class RoomManager {
            constructor() {
                this.roomCode = null;
                this.roomPeers = new Set();
            }

            generateRoomCode() {
                // 生成4位数字房间代码
                this.roomCode = Math.floor(1000 + Math.random() * 9000).toString();
                return this.roomCode;
            }

            setRoomCode(code) {
                this.roomCode = code;
            }

            getRoomCode() {
                return this.roomCode;
            }

            addPeerToRoom(peerId) {
                this.roomPeers.add(peerId);
            }

            removePeerFromRoom(peerId) {
                this.roomPeers.delete(peerId);
            }

            getRoomPeers() {
                return Array.from(this.roomPeers);
            }
        }

        // 聊天记录管理
        class ChatHistoryManager {
            constructor() {
                this.saveHistory = true;
                this.loadSettings();
            }

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
                this.saveHistory = settings.saveHistory !== undefined ? settings.saveHistory : true;
            }

            saveSettings() {
                const settings = {
                    saveHistory: this.saveHistory
                };
                localStorage.setItem('chat_settings', JSON.stringify(settings));
            }

            // 保存消息到本地存储
            saveMessage(roomId, message) {
                if (!this.saveHistory) return;
                
                try {
                    const key = `chat_history_${roomId}`;
                    let history = JSON.parse(localStorage.getItem(key) || '[]');
                    
                    // 限制历史记录数量，最多保存200条
                    if (history.length >= 200) {
                        history = history.slice(-190);
                    }
                    
                    history.push(message);
                    localStorage.setItem(key, JSON.stringify(history));
                } catch (error) {
                    console.error('保存消息失败:', error);
                }
            }

            // 从本地存储加载消息
            loadMessages(roomId) {
                if (!this.saveHistory) return [];
                
                try {
                    const key = `chat_history_${roomId}`;
                    return JSON.parse(localStorage.getItem(key) || '[]');
                } catch (error) {
                    console.error('加载消息失败:', error);
                    return [];
                }
            }

            // 清除聊天记录
            clearHistory(roomId) {
                try {
                    const key = `chat_history_${roomId}`;
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('清除聊天记录失败:', error);
                    return false;
                }
            }
        }

        // 初始化用户管理器、房间管理器和聊天记录管理器
        const userManager = new UserManager();
        const roomManager = new RoomManager();
        const chatHistoryManager = new ChatHistoryManager();

        // DOM 元素
        const elements = {
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            userList: document.getElementById('userList'),
            myId: document.getElementById('myId'),
            myAvatar: document.getElementById('myAvatar'),
            myUsername: document.getElementById('myUsername'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            roomCode: document.getElementById('roomCode'),
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
            peerCount: document.getElementById('peerCount'),
            notification: document.getElementById('notification')
        };

        // PeerJS 实例
        let peer;
        let myPeerId;

        // 初始化事件监听
        function initEvents() {
            // 发送消息按钮
            elements.sendButton.addEventListener('click', sendMessage);
            
            // 回车键发送消息
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 创建房间按钮
            elements.createRoomBtn.addEventListener('click', createRoom);
            
            // 加入房间按钮
            elements.joinRoomBtn.addEventListener('click', joinRoom);
            
            // 加载保存的用户名
            const savedUsername = userManager.loadUsername();
            if (savedUsername) {
                userManager.setUsername(savedUsername);
                elements.myUsername.textContent = savedUsername;
                elements.myAvatar.textContent = savedUsername[0].toUpperCase();
            } else {
                // 提示用户输入用户名
                setTimeout(() => {
                    const username = prompt('请输入您的昵称:', '匿名用户');
                    if (username) {
                        userManager.setUsername(username);
                        elements.myUsername.textContent = username;
                        elements.myAvatar.textContent = username[0].toUpperCase();
                    }
                }, 500);
            }
        }

        // 显示通知
        function showNotification(message, isError = false) {
            const notification = elements.notification;
            notification.textContent = message;
            notification.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--background-tertiary)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 初始化PeerJS
        function initPeerJS() {
            // 生成随机ID
            myPeerId = Math.random().toString(36).substr(2, 9);
            
            // 使用PeerJS建立连接
            peer = new Peer(myPeerId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                debug: 3
            });
            
            peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
                elements.myId.textContent = id;
                userManager.getCurrentUser().peerId = id;
                updateConnectionStatus('connected', '已连接');
                
                // 启用聊天功能
                elements.messageInput.disabled = false;
                elements.sendButton.disabled = false;
            });
            
            peer.on('connection', (conn) => {
                console.log('收到连接请求:', conn.peer);
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error('PeerJS错误:', err);
                updateConnectionStatus('error', '连接错误');
                showNotification('连接错误: ' + err, true);
            });
            
            peer.on('disconnected', () => {
                console.log('连接断开');
                updateConnectionStatus('disconnected', '连接断开');
                
                // 尝试重新连接
                setTimeout(() => {
                    peer.reconnect();
                }, 2000);
            });
        }

        // 创建房间
        function createRoom() {
            const roomCode = roomManager.generateRoomCode();
            elements.roomCode.textContent = roomCode;
            
            // 广播房间信息
            userManager.broadcast({
                type: 'room_created',
                roomCode: roomCode
            });
            
            showNotification(`已创建房间: ${roomCode}`);
            
            // 保存房间代码到URL
            updateURLWithRoomCode(roomCode);
        }

        // 加入房间
        function joinRoom() {
            const roomCode = prompt('请输入房间代码:');
            if (!roomCode) return;
            
            roomManager.setRoomCode(roomCode);
            elements.roomCode.textContent = roomCode;
            
            // 广播加入房间请求
            userManager.broadcast({
                type: 'join_room',
                roomCode: roomCode,
                user: userManager.getCurrentUser()
            });
            
            showNotification(`已加入房间: ${roomCode}`);
            
            // 保存房间代码到URL
            updateURLWithRoomCode(roomCode);
        }

        // 更新URL包含房间代码
        function updateURLWithRoomCode(roomCode) {
            const url = new URL(window.location);
            url.searchParams.set('room', roomCode);
            window.history.replaceState({}, '', url);
        }

        // 从URL获取房间代码
        function getRoomCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }

        // 连接到其他用户
        function connectToPeer(peerId) {
            if (peerId === myPeerId) return; // 不连接自己
            
            console.log('正在连接到:', peerId);
            
            // 建立连接
            const conn = peer.connect(peerId);
            
            conn.on('open', () => {
                console.log('连接成功:', peerId);
                setupConnection(conn);
                
                // 发送用户信息
                const user = userManager.getCurrentUser();
                conn.send({
                    type: 'user_join',
                    user: user.username,
                    identifier: user.identifier,
                    peerId: user.peerId
                });
                
                // 如果已加入房间，发送房间信息
                if (roomManager.getRoomCode()) {
                    conn.send({
                        type: 'room_info',
                        roomCode: roomManager.getRoomCode()
                    });
                }
            });
            
            conn.on('error', (err) => {
                console.error('连接错误:', err);
                showNotification('连接失败: ' + err, true);
            });
        }

        // 设置连接
        function setupConnection(conn) {
            // 存储连接
            userManager.addPeer(conn.peer, conn);
            
            // 监听数据
            conn.on('data', (data) => {
                handleIncomingData(data, conn.peer);
            });
            
            conn.on('close', () => {
                console.log('连接关闭:', conn.peer);
                const userInfo = userManager.getUserInfo(conn.peer);
                if (userInfo) {
                    addSystemMessage(`用户 ${userInfo.username} 已断开连接`);
                }
                userManager.removePeer(conn.peer);
                removeUserFromList(conn.peer);
            });
            
            conn.on('error', (err) => {
                console.error('连接错误:', err);
                userManager.removePeer(conn.peer);
                removeUserFromList(conn.peer);
            });
        }

        // 处理传入数据
        function handleIncomingData(data, peerId) {
            console.log('收到数据:', data);
            
            if (data.type === 'message') {
                // 保存到本地存储
                chatHistoryManager.saveMessage(roomManager.getRoomCode(), data);
                // 渲染消息
                renderMessage(data);
            } else if (data.type === 'user_join') {
                userManager.setUserInfo(peerId, data);
                addUserToList(peerId, data.user);
                addSystemMessage(`用户 ${data.user} 已加入聊天`);
                
                // 自动连接回这个用户
                if (data.peerId && !userManager.connectedPeers.has(data.peerId)) {
                    connectToPeer(data.peerId);
                }
            } else if (data.type === 'room_created') {
                roomManager.setRoomCode(data.roomCode);
                elements.roomCode.textContent = data.roomCode;
                addSystemMessage(`已加入房间: ${data.roomCode}`);
                updateURLWithRoomCode(data.roomCode);
            } else if (data.type === 'join_room') {
                if (data.roomCode === roomManager.getRoomCode()) {
                    // 同一个房间的用户，自动连接
                    connectToPeer(peerId);
                }
            } else if (data.type === 'room_info') {
                if (data.roomCode && !roomManager.getRoomCode()) {
                    roomManager.setRoomCode(data.roomCode);
                    elements.roomCode.textContent = data.roomCode;
                    addSystemMessage(`已加入房间: ${data.roomCode}`);
                    updateURLWithRoomCode(data.roomCode);
                }
            }
        }

        // 发送消息
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) return;
            
            const user = userManager.getCurrentUser();
            if (!user) return;
            
            const message = {
                type: 'message',
                user: user.username,
                identifier: user.identifier,
                text: text,
                timestamp: Date.now()
            };
            
            // 广播消息
            userManager.broadcast(message);
            
            // 保存到本地存储
            chatHistoryManager.saveMessage(roomManager.getRoomCode(), message);
            
            // 清空输入框
            elements.messageInput.value = '';
            
            // 本地渲染消息
            renderMessage(message);
        }

        // 渲染消息
        function renderMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${message.user[0]?.toUpperCase() || '?'}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.user}</span>
                        <span class="message-identifier">MAC: ${message.identifier.mac} | IP: ${message.identifier.ip}</span>
                        <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="message-text">${message.text}</div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // 添加系统消息
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // 添加用户到列表
        function addUserToList(peerId, username) {
            // 检查是否已存在
            if (document.getElementById(`user-${peerId}`)) return;
            
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.id = `user-${peerId}`;
            
            userItem.innerHTML = `
                <div class="user-avatar">${username[0]?.toUpperCase() || '?'}</div>
                <div>${username}</div>
            `;
            
            elements.userList.appendChild(userItem);
        }

        // 从列表中移除用户
        function removeUserFromList(peerId) {
            const userElement = document.getElementById(`user-${peerId}`);
            if (userElement) {
                userElement.remove();
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, text) {
            if (elements.statusDot && elements.statusText) {
                // 清除所有状态类
                elements.statusDot.className = 'status-dot';
                
                if (status === 'connected') {
                    elements.statusDot.classList.add('status-connected');
                } else if (status === 'connecting') {
                    elements.statusDot.classList.add('status-connecting');
                } else {
                    elements.statusDot.classList.add('status-disconnected');
                }
                
                elements.statusText.textContent = text;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initEvents();
            initPeerJS();
            
            // 检查URL中是否有房间代码
            const roomCode = getRoomCodeFromURL();
            if (roomCode) {
                roomManager.setRoomCode(roomCode);
                elements.roomCode.textContent = roomCode;
                addSystemMessage(`已自动加入房间: ${roomCode}`);
                
                // 广播加入房间请求
                setTimeout(() => {
                    if (userManager.connectedPeers.size > 0) {
                        userManager.broadcast({
                            type: 'join_room',
                            roomCode: roomCode,
                            user: userManager.getCurrentUser()
                        });
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
