<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>局域网WebRTC聊天室（全连接版）</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5865f2;
            --primary-hover: #4752c4;
            --background-primary: #36393f;
            --background-secondary: #2f3136;
            --background-tertiary: #202225;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --text-bright: #ffffff;
            --success-color: #3ba55d;
            --error-color: #ed4245;
            --warning-color: #faa81a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--background-primary);
            color: var(--text-normal);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: var(--background-secondary);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar {
            width: 300px;
            background: var(--background-tertiary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.06);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            background: var(--background-tertiary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--background-primary);
        }

        .chat-input {
            padding: 20px;
            background: var(--background-tertiary);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            font-size: 16px;
        }

        .send-button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-button:hover {
            background: var(--primary-hover);
        }

        .message {
            display: flex;
            margin-bottom: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 5px;
            gap: 10px;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-bright);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .message-text {
            font-size: 16px;
            line-height: 1.4;
            color: var(--text-normal);
        }

        .system-message {
            background: rgba(79, 84, 92, 0.3);
            color: var(--text-muted);
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .user-list {
            margin-top: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
            background: var(--background-primary);
            margin-top: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected {
            background: var(--success-color);
        }

        .status-connecting {
            background: var(--warning-color);
        }

        .status-disconnected {
            background: var(--error-color);
        }

        .connect-section {
            margin-top: 20px;
        }

        .connect-input {
            width: 100%;
            padding: 10px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            margin-bottom: 10px;
        }

        .connect-button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .my-id {
            background: var(--background-primary);
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
            word-break: break-all;
        }

        .id-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            background: var(--background-tertiary);
            color: var(--text-bright);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        .debug-panel {
            background: var(--background-tertiary);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .debug-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .debug-content {
            font-family: monospace;
            white-space: pre-wrap;
        }

        .toggle-debug {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            margin-top: 5px;
        }

        .server-config {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .server-select {
            width: 100%;
            padding: 8px;
            background: var(--background-primary);
            border: 2px solid var(--background-tertiary);
            border-radius: 5px;
            color: var(--text-normal);
            margin-bottom: 10px;
        }

        .action-button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .action-button.secondary {
            background: var(--background-primary);
        }
        
        .connection-type {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>聊天室成员 <span id="userCount">(1)</span></h3>
            <div class="user-list" id="userList">
                <div class="user-item" id="myUserItem">
                    <div class="user-avatar" id="myAvatar">ME</div>
                    <div id="myUsername">我</div>
                </div>
            </div>
            
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">正在连接...</span>
            </div>
            
            <div class="connect-section">
                <div class="id-label">我的ID:</div>
                <div class="my-id" id="myId">生成中...</div>
                
                <div class="id-label">连接其他用户:</div>
                <input type="text" class="connect-input" id="connectInput" placeholder="输入对方ID">
                <button class="connect-button" id="connectButton">连接</button>
            </div>
            
            <div class="server-config">
                <div class="id-label">信令服务器:</div>
                <select class="server-select" id="serverSelect">
                    <option value="default">默认服务器 (0.peerjs.com)</option>
                    <option value="heroku">Heroku服务器 (peerjs-server.herokuapp.com)</option>
                    <option value="custom">自定义服务器...</option>
                </select>
                <div id="customServerConfig" style="display: none;">
                    <input type="text" class="connect-input" id="customHost" placeholder="主机地址">
                    <input type="number" class="connect-input" id="customPort" placeholder="端口" value="443">
                    <input type="text" class="connect-input" id="customPath" placeholder="路径" value="/">
                </div>
                <button class="action-button secondary" id="reconnectButton">重新连接</button>
            </div>
            
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <div class="debug-title">调试信息:</div>
                <div class="debug-content" id="debugContent"></div>
            </div>
            <button class="toggle-debug" id="toggleDebug">显示调试信息</button>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h2>局域网WebRTC聊天室（全连接版）</h2>
                <div id="peerCount">直接连接: 0 | 中继连接: 0</div>
            </div>
            
            <div class="chat-messages" id="messagesContainer">
                <div class="system-message">
                    欢迎使用局域网WebRTC聊天室！所有用户都在同一频道中。
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" class="message-input" id="messageInput" placeholder="输入消息..." disabled>
                    <button class="send-button" id="sendButton" disabled>发送</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // 生成用户标识
        function generateUserIdentifier() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // 用户管理
        class UserManager {
            constructor() {
                this.currentUser = null;
                this.userIdentifier = this.loadUserIdentifier();
                this.connectedPeers = new Map(); // 直接连接
                this.relayPeers = new Map();     // 中继连接
                this.users = new Map();
                this.allUsers = new Set();       // 所有已知用户
            }

            loadUserIdentifier() {
                let identifier = localStorage.getItem('userIdentifier');
                if (!identifier) {
                    identifier = generateUserIdentifier();
                    localStorage.setItem('userIdentifier', identifier);
                }
                return identifier;
            }

            setUsername(username) {
                if (!username || username.trim() === '') {
                    username = '匿名用户';
                }
                
                this.currentUser = {
                    username: username.trim(),
                    identifier: this.userIdentifier,
                    peerId: null
                };
                
                localStorage.setItem('username', username);
                return this.currentUser;
            }

            loadUsername() {
                return localStorage.getItem('username') || '';
            }

            getCurrentUser() {
                return this.currentUser;
            }

            addPeer(peerId, connection, isRelay = false) {
                if (isRelay) {
                    this.relayPeers.set(peerId, connection);
                } else {
                    this.connectedPeers.set(peerId, connection);
                }
                
                this.updatePeerCount();
                return this.connectedPeers.size + this.relayPeers.size;
            }

            removePeer(peerId) {
                let removed = false;
                if (this.connectedPeers.has(peerId)) {
                    this.connectedPeers.delete(peerId);
                    removed = true;
                }
                if (this.relayPeers.has(peerId)) {
                    this.relayPeers.delete(peerId);
                    removed = true;
                }
                
                if (removed) {
                    this.updatePeerCount();
                }
                return this.connectedPeers.size + this.relayPeers.size;
            }

            updatePeerCount() {
                document.getElementById('peerCount').textContent = 
                    `直接连接: ${this.connectedPeers.size} | 中继连接: ${this.relayPeers.size}`;
                
                document.getElementById('statusText').textContent = 
                    `已连接 ${this.connectedPeers.size + this.relayPeers.size + 1} 人`;
                
                document.getElementById('userCount').textContent = 
                    `(${this.allUsers.size})`;
            }

            broadcast(message, excludePeerId = null) {
                // 广播到直接连接
                this.connectedPeers.forEach((conn, peerId) => {
                    if (peerId !== excludePeerId) {
                        try {
                            conn.send(message);
                        } catch (error) {
                            console.error('发送消息失败:', error);
                            addDebugLog('发送消息失败: ' + error.message);
                        }
                    }
                });
                
                // 广播到中继连接
                this.relayPeers.forEach((conn, peerId) => {
                    if (peerId !== excludePeerId) {
                        try {
                            conn.send(message);
                        } catch (error) {
                            console.error('发送中继消息失败:', error);
                            addDebugLog('发送中继消息失败: ' + error.message);
                        }
                    }
                });
            }

            getUserInfo(peerId) {
                return this.users.get(peerId);
            }

            setUserInfo(peerId, userInfo) {
                this.users.set(peerId, userInfo);
                this.allUsers.add(peerId);
            }

            addKnownUser(peerId) {
                this.allUsers.add(peerId);
                this.updatePeerCount();
            }

            removeKnownUser(peerId) {
                this.allUsers.delete(peerId);
                this.updatePeerCount();
            }
        }

        // 聊天记录管理
        class ChatHistoryManager {
            constructor() {
                this.saveHistory = true;
                this.loadSettings();
            }

            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('chat_settings') || '{}');
                this.saveHistory = settings.saveHistory !== undefined ? settings.saveHistory : true;
            }

            saveSettings() {
                const settings = {
                    saveHistory: this.saveHistory
                };
                localStorage.setItem('chat_settings', JSON.stringify(settings));
            }

            // 保存消息到本地存储
            saveMessage(message) {
                if (!this.saveHistory) return;
                
                try {
                    let history = JSON.parse(localStorage.getItem('chat_history') || '[]');
                    
                    // 限制历史记录数量，最多保存200条
                    if (history.length >= 200) {
                        history = history.slice(-190);
                    }
                    
                    history.push(message);
                    localStorage.setItem('chat_history', JSON.stringify(history));
                } catch (error) {
                    console.error('保存消息失败:', error);
                    addDebugLog('保存消息失败: ' + error.message);
                }
            }

            // 从本地存储加载消息
            loadMessages() {
                if (!this.saveHistory) return [];
                
                try {
                    return JSON.parse(localStorage.getItem('chat_history') || '[]');
                } catch (error) {
                    console.error('加载消息失败:', error);
                    addDebugLog('加载消息失败: ' + error.message);
                    return [];
                }
            }

            // 清除聊天记录
            clearHistory() {
                try {
                    localStorage.removeItem('chat_history');
                    return true;
                } catch (error) {
                    console.error('清除聊天记录失败:', error);
                    addDebugLog('清除聊天记录失败: ' + error.message);
                    return false;
                }
            }
        }

        // 初始化用户管理器和聊天记录管理器
        const userManager = new UserManager();
        const chatHistoryManager = new ChatHistoryManager();

        // DOM 元素
        const elements = {
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            userList: document.getElementById('userList'),
            myId: document.getElementById('myId'),
            myAvatar: document.getElementById('myAvatar'),
            myUsername: document.getElementById('myUsername'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            connectInput: document.getElementById('connectInput'),
            connectButton: document.getElementById('connectButton'),
            peerCount: document.getElementById('peerCount'),
            notification: document.getElementById('notification'),
            debugPanel: document.getElementById('debugPanel'),
            debugContent: document.getElementById('debugContent'),
            toggleDebug: document.getElementById('toggleDebug'),
            serverSelect: document.getElementById('serverSelect'),
            customServerConfig: document.getElementById('customServerConfig'),
            customHost: document.getElementById('customHost'),
            customPort: document.getElementById('customPort'),
            customPath: document.getElementById('customPath'),
            reconnectButton: document.getElementById('reconnectButton'),
            userCount: document.getElementById('userCount')
        };

        // PeerJS 实例
        let peer;
        let myPeerId;
        let debugLogs = [];
        let currentServerConfig = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // 服务器配置
        const SERVER_CONFIGS = {
            default: {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                label: '默认服务器'
            },
            heroku: {
                host: 'peerjs-server.herokuapp.com',
                port: 443,
                path: '/',
                label: 'Heroku服务器'
            },
            custom: {
                host: '',
                port: 443,
                path: '/',
                label: '自定义服务器'
            }
        };

        // 添加调试日志
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push(`[${timestamp}] ${message}`);
            
            // 限制日志数量
            if (debugLogs.length > 50) {
                debugLogs = debugLogs.slice(-50);
            }
            
            // 更新调试面板内容
            if (elements.debugPanel.style.display === 'block') {
                elements.debugContent.textContent = debugLogs.join('\n');
            }
        }

        // 初始化事件监听
        function initEvents() {
            // 发送消息按钮
            elements.sendButton.addEventListener('click', sendMessage);
            
            // 回车键发送消息
            elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 连接按钮
            elements.connectButton.addEventListener('click', connectToPeerInput);
            
            // 调试面板切换
            elements.toggleDebug.addEventListener('click', toggleDebugPanel);
            
            // 服务器选择
            elements.serverSelect.addEventListener('change', handleServerChange);
            
            // 重新连接按钮
            elements.reconnectButton.addEventListener('click', reconnectToServer);
            
            // 加载保存的用户名
            const savedUsername = userManager.loadUsername();
            if (savedUsername) {
                userManager.setUsername(savedUsername);
                elements.myUsername.textContent = savedUsername;
                elements.myAvatar.textContent = savedUsername[0].toUpperCase();
            } else {
                // 提示用户输入用户名
                setTimeout(() => {
                    const username = prompt('请输入您的昵称:', '匿名用户');
                    if (username) {
                        userManager.setUsername(username);
                        elements.myUsername.textContent = username;
                        elements.myAvatar.textContent = username[0].toUpperCase();
                    }
                }, 500);
            }
            
            // 加载服务器配置
            loadServerConfig();
            
            // 加载历史消息
            loadHistoryMessages();
        }

        // 加载历史消息
        function loadHistoryMessages() {
            const messages = chatHistoryManager.loadMessages();
            messages.forEach(message => {
                renderMessage(message);
            });
        }

        // 处理服务器选择变化
        function handleServerChange() {
            const selectedServer = elements.serverSelect.value;
            
            if (selectedServer === 'custom') {
                elements.customServerConfig.style.display = 'block';
                
                // 加载自定义服务器配置
                const customConfig = JSON.parse(localStorage.getItem('customServerConfig') || '{}');
                elements.customHost.value = customConfig.host || '';
                elements.customPort.value = customConfig.port || '443';
                elements.customPath.value = customConfig.path || '/';
            } else {
                elements.customServerConfig.style.display = 'none';
                currentServerConfig = {...SERVER_CONFIGS[selectedServer]};
                localStorage.setItem('selectedServer', selectedServer);
                
                // 重新连接
                reconnectToServer();
            }
        }

        // 保存自定义服务器配置
        function saveCustomServerConfig() {
            const customConfig = {
                host: elements.customHost.value,
                port: parseInt(elements.customPort.value) || 443,
                path: elements.customPath.value || '/'
            };
            
            localStorage.setItem('customServerConfig', JSON.stringify(customConfig));
            currentServerConfig = {...customConfig, label: '自定义服务器'};
            
            return customConfig;
        }

        // 加载服务器配置
        function loadServerConfig() {
            const selectedServer = localStorage.getItem('selectedServer') || 'default';
            elements.serverSelect.value = selectedServer;
            
            if (selectedServer === 'custom') {
                const customConfig = JSON.parse(localStorage.getItem('customServerConfig') || '{}');
                SERVER_CONFIGS.custom = {
                    ...SERVER_CONFIGS.custom,
                    ...customConfig
                };
                elements.customServerConfig.style.display = 'block';
                elements.customHost.value = customConfig.host || '';
                elements.customPort.value = customConfig.port || '443';
                elements.customPath.value = customConfig.path || '/';
            }
            
            currentServerConfig = {...SERVER_CONFIGS[selectedServer]};
        }

        // 重新连接到服务器
        function reconnectToServer() {
            if (elements.serverSelect.value === 'custom') {
                saveCustomServerConfig();
            }
            
            addDebugLog(`正在重新连接到服务器: ${currentServerConfig.label}`);
            updateConnectionStatus('connecting', '正在重新连接...');
            
            // 销毁现有Peer实例
            if (peer) {
                try {
                    peer.destroy();
                } catch (e) {
                    console.error('销毁Peer实例时出错:', e);
                }
            }
            
            // 重置重连尝试计数
            reconnectAttempts = 0;
            
            // 重新初始化
            setTimeout(initPeerJS, 1000);
        }

        // 显示通知
        function showNotification(message, isError = false) {
            const notification = elements.notification;
            notification.textContent = message;
            notification.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--background-tertiary)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 切换调试面板
        function toggleDebugPanel() {
            const isVisible = elements.debugPanel.style.display === 'block';
            elements.debugPanel.style.display = isVisible ? 'none' : 'block';
            elements.toggleDebug.textContent = isVisible ? '显示调试信息' : '隐藏调试信息';
            
            if (!isVisible) {
                elements.debugContent.textContent = debugLogs.join('\n');
            }
        }

        // 初始化PeerJS - 使用可配置服务器
        function initPeerJS() {
            // 生成随机ID
            myPeerId = Math.random().toString(36).substr(2, 9);
            
            addDebugLog(`正在初始化PeerJS连接至: ${currentServerConfig.host}`);
            updateConnectionStatus('connecting', `正在连接至 ${currentServerConfig.label}...`);
            
            // 使用配置的服务器
            peer = new Peer(myPeerId, {
                host: currentServerConfig.host,
                port: currentServerConfig.port,
                path: currentServerConfig.path,
                debug: 3,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                addDebugLog(`PeerJS连接已建立，ID: ${id} (服务器: ${currentServerConfig.label})`);
                elements.myId.textContent = id;
                userManager.getCurrentUser().peerId = id;
                userManager.addKnownUser(id);
                updateConnectionStatus('connected', `已连接到 ${currentServerConfig.label}`);
                
                // 启用聊天功能
                elements.messageInput.disabled = false;
                elements.sendButton.disabled = false;
                
                // 重置重连尝试计数
                reconnectAttempts = 0;
                
                // 广播用户加入消息
                broadcastUserJoin();
            });
            
            peer.on('connection', (conn) => {
                addDebugLog('收到连接请求: ' + conn.peer);
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                addDebugLog(`PeerJS错误 (${currentServerConfig.label}): ${err}`);
                
                if (err.toString().includes('Could not connect to peer server')) {
                    updateConnectionStatus('error', `无法连接到 ${currentServerConfig.label}`);
                    
                    // 尝试使用备选方案
                    reconnectAttempts++;
                    
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        addDebugLog(`尝试 ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}: 正在尝试其他服务器...`);
                        
                        // 切换到下一个服务器
                        switchToNextServer();
                        
                        // 延迟后重试
                        setTimeout(() => {
                            reconnectToServer();
                        }, 2000);
                    } else {
                        // 所有服务器尝试失败
                        updateConnectionStatus('error', '所有服务器连接失败');
                        showNotification('无法连接到任何信令服务器', true);
                    }
                } else {
                    updateConnectionStatus('error', '连接错误: ' + err);
                    showNotification('连接错误: ' + err, true);
                }
            });
            
            peer.on('disconnected', () => {
                addDebugLog('与信令服务器的连接已断开');
                updateConnectionStatus('disconnected', '连接断开');
                
                // 尝试重新连接
                setTimeout(() => {
                    addDebugLog('尝试重新连接到信令服务器...');
                    peer.reconnect();
                }, 2000);
            });
        }

        // 广播用户加入消息
        function broadcastUserJoin() {
            const user = userManager.getCurrentUser();
            
            // 向所有已知用户发送连接请求
            userManager.allUsers.forEach(peerId => {
                if (peerId !== user.peerId) {
                    connectToPeer(peerId, true);
                }
            });
            
            // 广播用户加入消息
            userManager.broadcast({
                type: 'user_join',
                user: user.username,
                identifier: user.identifier,
                peerId: user.peerId
            });
        }

        // 切换到下一个可用服务器
        function switchToNextServer() {
            const servers = ['default', 'heroku', 'custom'];
            const currentServer = elements.serverSelect.value;
            let currentIndex = servers.indexOf(currentServer);
            
            // 切换到下一个服务器
            currentIndex = (currentIndex + 1) % servers.length;
            const nextServer = servers[currentIndex];
            
            elements.serverSelect.value = nextServer;
            currentServerConfig = {...SERVER_CONFIGS[nextServer]};
            
            addDebugLog(`切换到服务器: ${currentServerConfig.label}`);
        }

        // 处理手动连接输入
        function connectToPeerInput() {
            const peerId = elements.connectInput.value.trim();
            if (!peerId) return;
            
            connectToPeer(peerId);
            elements.connectInput.value = '';
        }

        // 连接到其他用户
        function connectToPeer(peerId, isAutoConnect = false) {
            if (peerId === myPeerId) {
                if (!isAutoConnect) {
                    addDebugLog('不能连接到自己');
                    showNotification('不能连接到自己', true);
                }
                return;
            }
            
            // 检查是否已经连接
            if (userManager.connectedPeers.has(peerId) || userManager.relayPeers.has(peerId)) {
                if (!isAutoConnect) {
                    addDebugLog('已经连接到该用户: ' + peerId);
                    showNotification('已经连接到该用户', true);
                }
                return;
            }
            
            addDebugLog('正在连接到: ' + peerId);
            
            // 建立连接
            const conn = peer.connect(peerId, {
                reliable: true
            });
            
            if (!conn) {
                addDebugLog('创建连接对象失败');
                if (!isAutoConnect) {
                    showNotification('创建连接失败', true);
                }
                return;
            }
            
            conn.on('open', () => {
                addDebugLog('连接成功: ' + peerId);
                setupConnection(conn, false);
                
                // 发送用户信息
                const user = userManager.getCurrentUser();
                conn.send({
                    type: 'user_join',
                    user: user.username,
                    identifier: user.identifier,
                    peerId: user.peerId
                });
                
                if (!isAutoConnect) {
                    showNotification(`已连接到用户: ${peerId}`);
                }
            });
            
            conn.on('error', (err) => {
                addDebugLog('连接错误: ' + err);
                if (!isAutoConnect) {
                    showNotification('连接失败: ' + err, true);
                }
                
                // 尝试建立中继连接
                attemptRelayConnection(peerId);
            });
        }

        // 尝试建立中继连接
        function attemptRelayConnection(targetPeerId) {
            addDebugLog(`尝试通过中继连接到: ${targetPeerId}`);
            
            // 查找已经连接到目标用户的连接
            let relayConn = null;
            
            userManager.connectedPeers.forEach((conn, peerId) => {
                if (!relayConn) {
                    try {
                        conn.send({
                            type: 'relay_request',
                            targetPeerId: targetPeerId,
                            sourcePeerId: myPeerId
                        });
                        relayConn = conn;
                        addDebugLog(`通过 ${peerId} 中继到 ${targetPeerId}`);
                    } catch (e) {
                        console.error('中继请求发送失败:', e);
                    }
                }
            });
            
            if (!relayConn) {
                addDebugLog('找不到可用的中继连接');
            }
        }

        // 设置连接
        function setupConnection(conn, isIncoming = true) {
            // 存储连接
            userManager.addPeer(conn.peer, conn, !isIncoming);
            
            // 添加到已知用户列表
            userManager.addKnownUser(conn.peer);
            
            // 监听数据
            conn.on('data', (data) => {
                addDebugLog('收到数据: ' + JSON.stringify(data).substring(0, 100));
                handleIncomingData(data, conn.peer);
            });
            
            conn.on('close', () => {
                addDebugLog('连接关闭: ' + conn.peer);
                const userInfo = userManager.getUserInfo(conn.peer);
                if (userInfo) {
                    addSystemMessage(`用户 ${userInfo.username} 已断开连接`);
                }
                userManager.removePeer(conn.peer);
                userManager.removeKnownUser(conn.peer);
                removeUserFromList(conn.peer);
            });
            
            conn.on('error', (err) => {
                addDebugLog('连接错误: ' + err);
                userManager.removePeer(conn.peer);
                userManager.removeKnownUser(conn.peer);
                removeUserFromList(conn.peer);
            });
        }

        // 处理传入数据
        function handleIncomingData(data, peerId) {
            if (data.type === 'message') {
                // 保存到本地存储
                chatHistoryManager.saveMessage(data);
                // 渲染消息
                renderMessage(data);
                
                // 中继消息给其他用户
                if (data.relay) {
                    userManager.broadcast(data, peerId);
                }
            } else if (data.type === 'user_join') {
                userManager.setUserInfo(peerId, data);
                addUserToList(peerId, data.user);
                addSystemMessage(`用户 ${data.user} 已加入聊天`);
                
                // 尝试连接新用户
                if (data.peerId !== myPeerId) {
                    connectToPeer(data.peerId, true);
                }
            } else if (data.type === 'relay_request') {
                // 处理中继请求
                if (data.targetPeerId === myPeerId) {
                    addDebugLog(`收到来自 ${data.sourcePeerId} 的中继连接请求`);
                    
                    // 建立与源用户的中继连接
                    const relayConn = peer.connect(data.sourcePeerId, {
                        reliable: true
                    });
                    
                    if (relayConn) {
                        relayConn.on('open', () => {
                            addDebugLog(`中继连接已建立: ${data.sourcePeerId}`);
                            setupConnection(relayConn, false);
                            
                            // 通知源用户中继已建立
                            relayConn.send({
                                type: 'relay_established',
                                peerId: myPeerId
                            });
                        });
                    }
                }
            } else if (data.type === 'relay_established') {
                addDebugLog(`与 ${peerId} 的中继连接已建立`);
            }
        }

        // 发送消息
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) return;
            
            const user = userManager.getCurrentUser();
            if (!user) return;
            
            const message = {
                type: 'message',
                user: user.username,
                identifier: user.identifier,
                text: text,
                timestamp: Date.now(),
                relay: userManager.connectedPeers.size === 0 // 如果没有直接连接，需要中继
            };
            
            // 广播消息
            userManager.broadcast(message);
            
            // 保存到本地存储
            chatHistoryManager.saveMessage(message);
            
            // 清空输入框
            elements.messageInput.value = '';
            
            // 本地渲染消息
            renderMessage(message);
        }

        // 渲染消息
        function renderMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${message.user[0]?.toUpperCase() || '?'}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.user}</span>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // 格式化时间
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 添加系统消息
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // 添加用户到列表
        function addUserToList(peerId, username) {
            // 检查是否已存在
            if (document.getElementById(`user-${peerId}`)) return;
            
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.id = `user-${peerId}`;
            
            const connectionType = userManager.connectedPeers.has(peerId) ? 
                '<span class="connection-type">(直接)</span>' : 
                '<span class="connection-type">(中继)</span>';
            
            userItem.innerHTML = `
                <div class="user-avatar">${username[0]?.toUpperCase() || '?'}</div>
                <div>${username} ${connectionType}</div>
            `;
            
            elements.userList.appendChild(userItem);
        }

        // 从列表中移除用户
        function removeUserFromList(peerId) {
            const userElement = document.getElementById(`user-${peerId}`);
            if (userElement) {
                userElement.remove();
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, text) {
            if (elements.statusDot && elements.statusText) {
                // 清除所有状态类
                elements.statusDot.className = 'status-dot';
                
                if (status === 'connected') {
                    elements.statusDot.classList.add('status-connected');
                } else if (status === 'connecting') {
                    elements.statusDot.classList.add('status-connecting');
                } else {
                    elements.statusDot.classList.add('status-disconnected');
                }
                
                elements.statusText.textContent = text;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initEvents();
            initPeerJS();
        });
    </script>
</body>
</html>
